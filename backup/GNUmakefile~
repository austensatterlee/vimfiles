#our makefile variables.   Good to place commonly changed variables
# at the top of your makefile. Then follow with your rules.

DIM = 2
VPATH = . ../VisitWriter
CFLAGS = -Wall -I. -I../VisitWriter -std=c++11
CFLAGS += -O0
CFLAGS += -g
CXX = g++
#CXX = clang++
CPPFLAGS = -D DIM=$(DIM) 

ifeq ($(CXX) , clang++)
CFLAGS += -stdlib=libc++
endif

FEOBJS = FEPoissonOperator.o FEGrid.o Element.o Node.o SparseMatrix.o

all: TestMatrix fesolver

tests: tests/jacobi_test.exe tests/my_TestMatrix.exe

fesolver:  FEMain.cpp VisitWriter.o ReInsert.o JacobiSolver.o $(FEOBJS)
	  $(CXX) $(CPPFLAGS) $(CFLAGS) -o fesolver.exe FEMain.cpp $(FEOBJS) VisitWriter.o ReInsert.o JacobiSolver.o 

TestMatrix: TestMatrix.cpp SparseMatrix.o
	$(CXX) $(CPPFLAGS) $(CFLAGS) -o testmatrix.exe TestMatrix.cpp SparseMatrix.o

ShowMesh: VisitWriter.o ShowMesh.cpp
	$(CXX) -I$(VPATH) $(CFLAGS) -o ShowMesh.exe ShowMesh.cpp VisitWriter.o

testFEGrid: $(FEOBJS) testFEGrid.cpp VisitWriter.o
	$(CXX) $(CPPFLAGS) $(CFLAGS) -o testFEGrid.exe testFEGrid.cpp $(FEOBJS) VisitWriter.o 

tests/jacobi_test.exe: tests/jacobi_test.cpp SparseMatrix.o JacobiSolver.o
	@echo "Linking test... "
	$(CXX) $(CPPFLAGS) $(CFLAGS) $^ -o $@

tests/my_TestMatrix.exe: tests/my_TestMatrix.cpp SparseMatrix.o
	@echo "Linking test... "
	$(CXX) $(CPPFLAGS) $(CFLAGS) $< -o $@ 

%.o:%.cpp GNUmakefile
	$(CXX) -c $(CPPFLAGS) $(CFLAGS) $< -o $@
	$(CXX) -MM $(CFLAGS) $< > $*.d


clean:
	rm -r *.o *.d *.exe *.dSYM tests/*.exe
-include $(OBJS:.o=.d)
